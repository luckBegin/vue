<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>抽奖</title>
    <link rel="stylesheet" type="text/css" href="./css/style.css">
    <style>
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
    </style>
</head>
<body>
<div class="container">
    <canvas id="canvas">

    </canvas>

    <img src="./img/fen.gif" alt="" style="position: absolute;top: 14%">
    <img src="./img/fen.gif" alt="" style="position: absolute;top: 13%;left: 291px;">
    <div class="wrapper">
        <div class="resetTime">
            <div class="text">
                倒<br/>
                计<br/>
                时<br/>
            </div>
            <div id="time" onclick="start()">
                启动
            </div>
        </div>

        <div class="top">
            <div class="section">
                <img src="./img/1.png" alt="" class="crown">
                <img src="./img//head.png" alt="" class="portrail">
                <div class="perName">
                    XXX
                </div>
                <div class="score">
                    0
                </div>
            </div>

            <div class="section" style="">
                <img src="./img/1.png" alt="" class="crown">
                <img src="./img//head.png" alt="" class="portrail">
                <div class="perName">
                    XXX
                </div>
                <div class="score">
                    0
                </div>
            </div>

            <div class="section" style="">
                <img src="./img/1.png" alt="" class="crown">
                <img src="./img//head.png" alt="" class="portrail">
                <div class="perName">
                    XXX
                </div>
                <div class="score">
                    0
                </div>
            </div>

            <div class="section" style="">
                <img src="./img/1.png" alt="" class="crown">
                <img src="./img//head.png" alt="" class="portrail">
                <div class="perName">
                    XXX
                </div>
                <div class="score">
                    0
                </div>
            </div>

            <div class="section">
                <img src="./img/1.png" alt="" class="crown">
                <img src="./img//head.png" alt="" class="portrail">
                <div class="perName">
                    XXX
                </div>
                <div class="score">
                    0
                </div>
            </div>

        </div>

        <div class="footerWrap">
            <div class="footer scroll">
                <div class="rankWrap ">
                    <div class="rank">
                        <div class="rankTitle">
                            6
                        </div>
                        <div class="rankBar">
                            <div class="rankItem">

                            </div>
                        </div>
                        <div>
                            <img src="./img//head.png" alt="" class="portrail2">
                        </div>
                        <p class="name">
                            XXX
                        </p>
                    </div>
                </div>

                <div class="rankWrap">
                    <div class="rank">
                        <div class="rankTitle">
                            7
                        </div>
                        <div class="rankBar">
                            <div class="rankItem">

                            </div>
                        </div>
                        <div>
                            <img src="./img//head.png" alt="" class="portrail2">
                        </div>
                        <p class="name">
                            XXX
                        </p>
                    </div>
                </div>

                <div class="rankWrap">
                    <div class="rank">
                        <div class="rankTitle">
                            8
                        </div>
                        <div class="rankBar">
                            <div class="rankItem">

                            </div>
                        </div>
                        <div>
                            <img src="./img//head.png" alt="" class="portrail2">
                        </div>
                        <p class="name">
                            XXX
                        </p>
                    </div>
                </div>

                <div class="rankWrap">
                    <div class="rank">
                        <div class="rankTitle">
                            9
                        </div>
                        <div class="rankBar">
                            <div class="rankItem">

                            </div>
                        </div>
                        <div>
                            <img src="./img//head.png" alt="" class="portrail2">
                        </div>
                        <p class="name">
                            XXX
                        </p>
                    </div>
                </div>

                <div class="rankWrap">
                    <div class="rank">
                        <div class="rankTitle">
                            10
                        </div>
                        <div class="rankBar">
                            <div class="rankItem">

                            </div>
                        </div>
                        <div>
                            <img src="./img//head.png" alt="" class="portrail2">
                        </div>
                        <p class="name">
                            XXX
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!--<img src="./img/qr.png" alt="" style="position: absolute;bottom: 10%;width: 190px;left: 21%;">-->
</div>
<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script>
    var host = 'http://jichang.yoopoon.com' ;
    var reset = function (data) {
        var html = '';

        if(!data)
            return
        data.forEach((item, index) => {
            html += "<div class='section' style=''>" +
                "				<img src='./img/" + (index + 1) + ".png' alt='' class='crown'>" +
                "				<img src='" + item.UserWXimg + "' alt='' class='portrail'>" +
                "				<div class='perName'>" + item.UserWXnickName +
                "				</div>" +
                "				<div class='score'>" + item.count +
                "				</div>" +
                "			</div>";
        });
        if (html == '')
            document.querySelector(".top").innerHTML = "<div style='color: #cfb37b;'>已无更多人数</div>";
        else
            document.querySelector(".top").innerHTML = html;
    };
    var last = function (data) {
        var html = '';
        if(!data)
            return
        data.forEach((item, index) => {
            if(index > 5 ){
                var width = item.count ;
                html += "<div class='rankWrap'> <div class='rank'>" +
                    "				<div class='rankTitle'>" + (index) +
                    "				</div>" +
                    "				<div class='rankBar'>" +
                    "					<div class='rankItem' style='width :" + width + "px'>" +
                    "					</div>" +
                    "				</div>" +
                    "				<div>" +
                    "				<img src='" + item.UserWXimg + "' alt='' class='portrail2'>" +
                    "				</div>" +
                    "				<p class='name'>" + item.UserWXnickName +
                    "				</p>" +
                    "			</div></div>";
            }

        });
        document.querySelector(".footer").innerHTML = html;
    };

    var ws = new WebSocket('ws://jichang.yoopoon.com/websocket');

    ws.onopen = () => {
        heartCheck.reset().start();      //心跳检测重置
    };

    ws.onmessage = msg => {
        heartCheck.reset().start();
        var message = JSON.parse(msg.data);

        if (message.action === 'start') {
            var text = message.time; ;

            if(parseInt(message.time) >= 22 )
                text = '预备' ;
            if(parseInt(message.time) === 21 )
                text = '开始';

            document.querySelector("#time").innerText = text

            var topFive = message.data
            var lastFive = message.rest;

            reset(topFive);
            last(lastFive);
        }
        ;

        if (message.action === 'end') {
            document.querySelector("#time").innerText = "启动";

            var topFive = message.data
            var lastFive = message.rest;

            reset(topFive);
            last(lastFive);

            var str = '' ;
            topFive.forEach( item =>{
                str += item.UserWXopenId +","
            });
            $.ajax({
                url: "https://kmgoapi.yoopoon.com/api/home/wdaUpdzhongjiangUser",
                method: "POST",
                data :{OpenId : str} ,
                success: function (data) {
                }
            })
        }
        ;
    };

    ws.onclose = function () {
        console.log('连接已关闭...');
        // window.location.reload() ;
    };

    var send = function (data) {
        if (ws.readyState === 1) {
            ws.send(JSON.stringify(data));
        } else {
            setTimeout(function () {
                send(data);
            }, 100);
        }
        ;
    };

    var start = function () {
        $.ajax({
            url: "https://kmgoapi.yoopoon.com/api/home/GetwdaGetUserinfo",
            method: "GET",
            success: function (data) {
                if (data.Status === 1 && data.Values && data.Values.length > 0) {
                    send({type: 'start', 'info': {time: 25, award: 5, list: data.Values}});
                } else {
                    alert("获取当前在线用户失败");
                }
            }
        })
        // send({type:'start' , 'info' : { time : 21 , award : 10 } , list : list }) ;
    }

    var heartCheck = {
        timeout: 30000,        //9分钟发一次心跳
        timeoutObj: null,
        serverTimeoutObj: null,
        reset: function(){
            clearTimeout(this.timeoutObj);
            clearTimeout(this.serverTimeoutObj);
            return this;
        },
        start: function(){
            var self = this;
            this.timeoutObj = setTimeout(function(){
                //这里发送一个心跳，后端收到后，返回一个心跳消息，
                //onmessage拿到返回的心跳就说明连接正常
                ws.send(JSON.stringify({type:"ping"}));
                console.log("ping!")
                self.serverTimeoutObj = setTimeout(function(){//如果超过一定时间还没重置，说明后端主动断开了
                    ws.close();     //如果onclose会执行reconnect，我们执行ws.close()就行了.如果直接执行reconnect 会触发onclose导致重连两次
                }, self.timeout)
            }, this.timeout)
        }
    }
    window.onbeforeunload = function() {
        ws.close();
    };



    //
	var image = new Image();
	var dots = [];
	image.src = './default.png';

	var image2 = new Image();
	image2.src = './raw_small.png';
	image2.onload = function () {
		dots = getimgData("YGA");
		initAnimate();
	};

	var imgObj = [];
	var canvas = document.getElementById("canvas");
	var context = canvas.getContext('2d');

	canvas.width = document.body.clientWidth;
	canvas.height = document.body.clientHeight;

	focallength = 100;

	var drawText = function (text) {
		context.save()
		context.drawImage(image2, 0, 0);

		context.restore();
	};

	function getimgData(text) {
		drawText(text);
		var imgData = context.getImageData(0, 0, canvas.width, canvas.height);
		context.clearRect(0, 0, canvas.width, canvas.height);
		var dots = [];
		for (var x = 0; x < imgData.width; x += 15 ) {
			for (var y = 0; y < imgData.height; y += 15 ) {
				var i = (y * imgData.width + x) * 4;
				if (imgData.data[i] > 0) {
					var dot = new Dot(x + 3, y + 3, 0, 3, dots.length);
					dots.push(dot);
				}
			}
		}
		return dots;
	};

	var Dot = function (centerX, centerY, centerZ, radius, index) {
		this.dx = centerX;
		this.dy = centerY;
		this.dz = centerZ;

		this.z = centerZ;
		this.x = centerX;
		this.y = centerY;
		this.radius = radius;

		this.index = index;
	}

	Dot.prototype = {
		paint: function (index) {
			context.save();
			context.beginPath();
			var scale = focallength / (focallength + this.z);
			var _img = null;

			if (imgObj[this.index])
				_img = imgObj[this.index];
			else
				_img = image;
			context.drawImage(_img, canvas.width / 1.9 + (this.x - canvas.width / 2) * scale, canvas.height / 2 + (this.y - canvas.height / 2) * scale + canvas.height / 1.6, 15, 15);
			context.stroke()
			context.restore();
		}
	};


	function initAnimate() {
		dots.forEach((_this, index) => {
			_this.x = Math.random() * canvas.width;
			_this.y = Math.random() * canvas.height;
			_this.z = Math.random() * focallength * 2 - focallength;

			_this.tx = Math.random() * canvas.width;
			_this.ty = Math.random() * canvas.height;
			_this.tz = Math.random() * focallength * 2 - focallength;
			_this.paint(index);
		});
		animate();
	};

	var derection = true;

	function animate() {
		context.clearRect(0, 0, canvas.width, canvas.height);
		dots.forEach(function (item, index) {
			var dot = item;
			if (derection === true) {
				if (Math.abs(dot.dx - dot.x) <= 0.1 && Math.abs(dot.dy - dot.y) <= 0.1 && Math.abs(dot.dz - dot.z) <= 0.1) {

				} else {
					dot.x = dot.x + (dot.dx - dot.x) * 0.04;
					dot.y = dot.y + (dot.dy - dot.y) * 0.04;
					dot.z = dot.z + (dot.dz - dot.z) * 0.04;
				}
				;
			} else {
				if (Math.abs(dot.tx - dot.x) < 0.1 && Math.abs(dot.ty - dot.y) < 0.1 && Math.abs(dot.tz - dot.z) < 0.1) {
					derection = true;
				} else {
					dot.x = dot.x + (dot.tx - dot.x) * 0.03;
					dot.y = dot.y + (dot.ty - dot.y) * 0.03;
					dot.z = dot.z + (dot.tz - dot.z) * 0.03;
				}
				;
			}
			;
			dot.paint(index);
		});
		// requestAnimationFrame(animate);
	};
	var timer = setInterval(function(){
		animate() ;
	} , 10)
	var obj = [];
	var start = function () {
		$.ajax({
			url: "https://kmgoapi.yoopoon.com/api/home/GetwdaGetUserinfo",
			method: "GET",
			success: function (data) {
				if (data.Status === 1 && data.Values && data.Values.length > 0) {
					data.Values.forEach(item => {
						if (obj[item.UserWXopenId]) {
						} else {
							obj[item.UserWXopenId] = true;
							var img = new Image();
							img.src = item.UserWXimg;
							img.onload = function () {
								imgObj.push(img);
							};
						}

					});
				} else {
					alert("获取当前在线用户失败");
				}
			}
		})
	};
	start();
</script>
</body>
</html>